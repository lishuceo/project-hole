# è„šæœ¬æ‰§è¡Œæ•ˆç‡æµ‹è¯•æ¨¡å¼

## æ¦‚è¿°

ScriptPerformanceTest æ˜¯ä¸€ä¸ªä¸“é—¨ç”¨äºæµ‹è¯•è„šæœ¬ç¯å¢ƒæ‰§è¡Œæ•ˆç‡çš„æ¸¸æˆæ¨¡å¼ã€‚è¯¥æ¨¡å¼æ— éœ€åœºæ™¯å’Œé»˜è®¤åœºæ™¯ï¼Œä»…æä¾›UIç•Œé¢è¿›è¡Œæ€§èƒ½æµ‹è¯•ã€‚

## åŠŸèƒ½ç‰¹æ€§

### ğŸ¯ æµ‹è¯•èŒƒå›´
- **æœåŠ¡ç«¯è„šæœ¬æµ‹è¯•**: æµ‹è¯•æœåŠ¡ç«¯è„šæœ¬æ‰§è¡Œç¯å¢ƒçš„æ€§èƒ½
- **å®¢æˆ·ç«¯è„šæœ¬æµ‹è¯•**: æµ‹è¯•å®¢æˆ·ç«¯è„šæœ¬æ‰§è¡Œç¯å¢ƒçš„æ€§èƒ½

### ğŸ§ª æµ‹è¯•é¡¹ç›®
æ¯ä¸ªæµ‹è¯•ç¯å¢ƒæä¾›ä¸‰ç§æµ‹è¯•ï¼š
1. **æµ‹è¯•åŠ æ³•Xæ¬¡**: çº¯è®¡ç®—æ€§èƒ½æµ‹è¯•
2. **æµ‹è¯•è„šæœ¬è°ƒç”¨å®¿ä¸»Xæ¬¡**: è„šæœ¬->å®¿ä¸»è°ƒç”¨æ€§èƒ½
3. **æµ‹è¯•å®¿ä¸»è°ƒç”¨è„šæœ¬Xæ¬¡**: å®¿ä¸»->è„šæœ¬è°ƒç”¨æ€§èƒ½

### ğŸ¨ UIç•Œé¢
- **æµå¼å¸ƒå±€**: ä½¿ç”¨ç°ä»£åŒ–çš„æµå¼UIå¸ƒå±€ï¼Œç•Œé¢æ¸…æ™°ç›´è§‚
- **åŠ¨æ€è¾“å…¥**: å¯è‡ªå®šä¹‰æµ‹è¯•æ¬¡æ•°ï¼ˆé»˜è®¤10000æ¬¡ï¼‰
- **å®æ—¶ç»“æœ**: æ˜¾ç¤ºè¯¦ç»†çš„æ€§èƒ½æµ‹è¯•ç»“æœ
- **åˆ†ç±»å±•ç¤º**: æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯æµ‹è¯•ç»“æœåˆ†åˆ«å±•ç¤º

## ä½¿ç”¨æ–¹æ³•

### 1. å¯åŠ¨æµ‹è¯•æ¨¡å¼

åœ¨ `GlobalConfig.cs` ä¸­è®¾ç½®æµ‹è¯•æ¨¡å¼ï¼š
```csharp
GameDataGlobalConfig.TestGameMode = ScopeData.GameMode.ScriptPerformanceTest;
```

æˆ–è€…åœ¨è¿è¡Œæ—¶é€‰æ‹© "ScriptPerformanceTest" æ¨¡å¼ã€‚

### 2. ç•Œé¢æ“ä½œ

1. **è®¾ç½®æµ‹è¯•æ¬¡æ•°**: åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥è¦æµ‹è¯•çš„æ¬¡æ•°ï¼ˆé»˜è®¤10000ï¼‰
2. **é€‰æ‹©æµ‹è¯•ç¯å¢ƒ**: ç‚¹å‡»æœåŠ¡ç«¯æˆ–å®¢æˆ·ç«¯åŒºåŸŸçš„æµ‹è¯•æŒ‰é’®
3. **é€‰æ‹©æµ‹è¯•ç±»å‹**: 
   - åŠ æ³•æµ‹è¯•ï¼šçº¯è®¡ç®—æ€§èƒ½
   - è„šæœ¬è°ƒç”¨å®¿ä¸»ï¼šè„šæœ¬->å®¿ä¸»æ¥å£è°ƒç”¨æ€§èƒ½
   - å®¿ä¸»è°ƒç”¨è„šæœ¬ï¼šå®¿ä¸»->è„šæœ¬å‡½æ•°è°ƒç”¨æ€§èƒ½
4. **æŸ¥çœ‹ç»“æœ**: æµ‹è¯•å®ŒæˆåæŸ¥çœ‹è¯¦ç»†çš„æ€§èƒ½æ•°æ®

### 3. ç»“æœè§£è¯»

æµ‹è¯•ç»“æœåŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š
- **æ‰§è¡Œæ¬¡æ•°**: å®é™…æ‰§è¡Œçš„æµ‹è¯•æ¬¡æ•°
- **æ€»è€—æ—¶**: æ€»å…±èŠ±è´¹çš„æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
- **å¹³å‡è€—æ—¶**: å•æ¬¡æ“ä½œçš„å¹³å‡è€—æ—¶ï¼ˆçº³ç§’ï¼‰
- **æ¯ç§’æ‰§è¡Œ**: æ¯ç§’èƒ½æ‰§è¡Œçš„æ“ä½œæ•°é‡

## å¼€å‘è€…å®šåˆ¶

### å®ç°è‡ªå®šä¹‰æµ‹è¯•é€»è¾‘

ç³»ç»Ÿç°åœ¨ä½¿ç”¨TypedMessageè¿›è¡Œå®¢æˆ·ç«¯-æœåŠ¡ç«¯é€šä¿¡ã€‚æœåŠ¡ç«¯æµ‹è¯•åœ¨æœåŠ¡ç«¯æ‰§è¡Œï¼Œå®¢æˆ·ç«¯æµ‹è¯•åœ¨å®¢æˆ·ç«¯æ‰§è¡Œï¼š

#### æœåŠ¡ç«¯æµ‹è¯•å®ç°
æœåŠ¡ç«¯æµ‹è¯•é€»è¾‘åœ¨ `ScriptPerformanceTestServer.cs` ä¸­å®ç°ï¼š

```csharp
// åœ¨ ScriptPerformanceTestServer.cs ä¸­ä¿®æ”¹ä»¥ä¸‹æ–¹æ³•ï¼š
private static async Task ExecuteAdditionTest(int count, ScriptPerformanceTestResult result)
private static async Task ExecuteScriptToHostCallTest(int count, ScriptPerformanceTestResult result)  
private static async Task ExecuteHostToScriptCallTest(int count, ScriptPerformanceTestResult result)
```

#### å®¢æˆ·ç«¯æµ‹è¯•å®ç°
å®¢æˆ·ç«¯æµ‹è¯•é€»è¾‘åœ¨ `ScriptPerformanceTestMode.cs` ä¸­å®ç°ï¼š

```csharp
// åœ¨ ScriptPerformanceTestMode.cs ä¸­ä¿®æ”¹ä»¥ä¸‹æ–¹æ³•ï¼š
private void RunClientAdditionTest()     // å®¢æˆ·ç«¯åŠ æ³•æµ‹è¯•
private void RunClientScriptToHostTest() // å®¢æˆ·ç«¯è„šæœ¬è°ƒç”¨å®¿ä¸»æµ‹è¯•
private void RunClientHostToScriptTest() // å®¢æˆ·ç«¯å®¿ä¸»è°ƒç”¨è„šæœ¬æµ‹è¯•
```

### æœåŠ¡ç«¯æµ‹è¯•å®ç°ç¤ºä¾‹

```csharp
private static async Task ExecuteAdditionTest(int count, ScriptPerformanceTestResult result)
{
    // TODO: ç”¨æˆ·å¯ä»¥åœ¨è¿™é‡Œå®ç°å®é™…çš„è„šæœ¬åŠ æ³•æµ‹è¯•é€»è¾‘
    // è¿™é‡Œæä¾›ä¸€ä¸ªåŸºç¡€çš„ç¤ºä¾‹ï¼Œç”¨æˆ·åº”è¯¥æ›¿æ¢ä¸ºå®é™…çš„è„šæœ¬å¼•æ“è°ƒç”¨
    
    double total = 0;
    for (int i = 0; i < count; i++)
    {
        // æ›¿æ¢ä¸ºå®é™…çš„è„šæœ¬å¼•æ“åŠ æ³•è°ƒç”¨
        // total += ScriptEngine.Execute($"return {i} + {i * 1.5}");
        total += i * 1.5; // å ä½ç¬¦å®ç°
    }
    
    result.AdditionalInfo["FinalResult"] = total;
    result.AdditionalInfo["TestDescription"] = "Script engine addition test";
    
    await Game.Delay(TimeSpan.FromMilliseconds(1));
}
```

### TypedMessageé€šä¿¡æµç¨‹

1. **å®¢æˆ·ç«¯**: ç”¨æˆ·ç‚¹å‡»æœåŠ¡ç«¯æµ‹è¯•æŒ‰é’®
2. **å®¢æˆ·ç«¯**: åˆ›å»º `ScriptPerformanceTestRequest` æ¶ˆæ¯å‘é€åˆ°æœåŠ¡ç«¯
3. **æœåŠ¡ç«¯**: æ¥æ”¶è¯·æ±‚ï¼Œæ‰§è¡Œå®é™…çš„è„šæœ¬æ€§èƒ½æµ‹è¯•
4. **æœåŠ¡ç«¯**: å®Œæˆæµ‹è¯•åï¼Œå‘é€ `ScriptPerformanceTestResult` æ¶ˆæ¯å›å®¢æˆ·ç«¯
5. **å®¢æˆ·ç«¯**: æ¥æ”¶ç»“æœå¹¶åœ¨UIä¸­æ˜¾ç¤ºè¯¦ç»†çš„æ€§èƒ½æ•°æ®

## æŠ€æœ¯å®ç°

### æ¶æ„è®¾è®¡
- **æ¡ä»¶ç¼–è¯‘**: ä½¿ç”¨ `#if CLIENT` å’Œ `#if SERVER` ç¡®ä¿ä»£ç åªåœ¨å¯¹åº”ç«¯ç¼–è¯‘
- **TypedMessageé€šä¿¡**: ä½¿ç”¨å¼ºç±»å‹æ¶ˆæ¯è¿›è¡Œå®¢æˆ·ç«¯-æœåŠ¡ç«¯é€šä¿¡
- **å•ä¾‹æ¨¡å¼**: ä½¿ç”¨å•ä¾‹æ¨¡å¼ç®¡ç†æ¸¸æˆæ¨¡å¼å®ä¾‹
- **äº‹ä»¶é©±åŠ¨**: é€šè¿‡æ¸¸æˆç³»ç»Ÿäº‹ä»¶è¿›è¡Œåˆå§‹åŒ–
- **æµå¼UI**: ä½¿ç”¨WasiCoreçš„æµå¼UI APIæ„å»ºç•Œé¢

### é€šä¿¡æœºåˆ¶
- **æ¶ˆæ¯å®šä¹‰**: `ScriptPerformanceTestRequest` å’Œ `ScriptPerformanceTestResult`
- **å¼‚æ­¥å¤„ç†**: æ‰€æœ‰ç½‘ç»œé€šä¿¡éƒ½æ˜¯å¼‚æ­¥çš„ï¼Œä¸é˜»å¡UI
- **è¶…æ—¶å¤„ç†**: 30ç§’è¶…æ—¶æœºåˆ¶ï¼Œé˜²æ­¢è¯·æ±‚æŒ‚èµ·
- **é”™è¯¯å¤„ç†**: å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·åé¦ˆ

### æ€§èƒ½è€ƒè™‘
- **é«˜ç²¾åº¦è®¡æ—¶**: ä½¿ç”¨ `Stopwatch` è¿›è¡Œé«˜ç²¾åº¦æ€§èƒ½æµ‹é‡
- **æœåŠ¡ç«¯æ‰§è¡Œ**: æœåŠ¡ç«¯æµ‹è¯•åœ¨æœåŠ¡ç«¯æ‰§è¡Œï¼Œé¿å…ç½‘ç»œå»¶è¿Ÿå½±å“
- **å†…å­˜å‹å¥½**: é¿å…åœ¨æµ‹è¯•å¾ªç¯ä¸­åˆ†é…å†…å­˜
- **çº¿ç¨‹å®‰å…¨**: ç¡®ä¿UIæ›´æ–°åœ¨ä¸»çº¿ç¨‹è¿›è¡Œ

### æ‰©å±•æ€§
- **æ¨¡å—åŒ–è®¾è®¡**: æµ‹è¯•æ–¹æ³•ç‹¬ç«‹ï¼Œæ˜“äºæ‰©å±•æ–°çš„æµ‹è¯•ç±»å‹
- **é…ç½®åŒ–**: æµ‹è¯•å‚æ•°å¯é€šè¿‡UIåŠ¨æ€é…ç½®
- **ç»“æœæ ‡å‡†åŒ–**: ç»Ÿä¸€çš„ç»“æœæ ¼å¼ï¼ŒåŒ…å«è¯¦ç»†çš„æ€§èƒ½æŒ‡æ ‡
- **åŒç«¯æ”¯æŒ**: åŒæ—¶æ”¯æŒå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ€§èƒ½æµ‹è¯•

## æ³¨æ„äº‹é¡¹

1. **æµ‹è¯•ç¯å¢ƒ**: ç¡®ä¿åœ¨ç›¸åŒçš„ç¯å¢ƒæ¡ä»¶ä¸‹è¿›è¡Œæµ‹è¯•ä»¥è·å¾—å¯æ¯”è¾ƒçš„ç»“æœ
2. **æµ‹è¯•æ¬¡æ•°**: å»ºè®®æµ‹è¯•æ¬¡æ•°ä¸å°‘äº1000æ¬¡ä»¥è·å¾—ç¨³å®šçš„æ€§èƒ½æ•°æ®
3. **èµ„æºå ç”¨**: å¤§é‡æµ‹è¯•å¯èƒ½å ç”¨è¾ƒå¤šCPUèµ„æºï¼Œæ³¨æ„ç³»ç»Ÿè´Ÿè½½
4. **ç»“æœåˆ†æ**: å…³æ³¨å¹³å‡è€—æ—¶ï¼ˆçº³ç§’ï¼‰å’Œæ¯ç§’æ‰§è¡Œæ¬¡æ•°ï¼Œè€Œä¸ä»…ä»…æ˜¯æ€»è€—æ—¶

## æœªæ¥æ‰©å±•

å¯ä»¥è€ƒè™‘æ·»åŠ ä»¥ä¸‹åŠŸèƒ½ï¼š
- **æ‰¹é‡æµ‹è¯•**: æ”¯æŒå¤šç§æµ‹è¯•çš„æ‰¹é‡æ‰§è¡Œ
- **ç»“æœå¯¼å‡º**: æ”¯æŒå°†æµ‹è¯•ç»“æœå¯¼å‡ºä¸ºCSVæˆ–JSONæ ¼å¼
- **å¯¹æ¯”åˆ†æ**: æ”¯æŒå¤šæ¬¡æµ‹è¯•ç»“æœçš„å¯¹æ¯”åˆ†æ
- **å†…å­˜æµ‹è¯•**: æ·»åŠ å†…å­˜åˆ†é…å’Œåƒåœ¾å›æ”¶çš„æ€§èƒ½æµ‹è¯•
- **å¼‚æ­¥æµ‹è¯•**: æ·»åŠ å¼‚æ­¥æ“ä½œçš„æ€§èƒ½æµ‹è¯•

---

**å¼€å‘çŠ¶æ€**: âœ… åŸºç¡€æ¡†æ¶å®Œæˆï¼Œç­‰å¾…è„šæœ¬æµ‹è¯•é€»è¾‘å®ç°
